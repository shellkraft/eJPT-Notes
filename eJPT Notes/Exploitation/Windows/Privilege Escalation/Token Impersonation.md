
### What are Windows Access Tokens ?

- Windows access tokens are a core element of the authentication process on Windows and are created and managed by the Local Security Authority Subsystem Service (LSASS).

- A Windows access token is responsible for identifying and describing the security context of a process or thread running on a system. Simply put, an access token can be thought of as a temporary key akin to a web cookie that provides users with access to a system or network resource without having to provide credentials each time a process is started or a system resource is accessed.

- Access tokens are generated by the `winlogon.exe` process every time a user authenticates successfully and includes the identity and privileges of the user account associated with the thread or process. This token is then attached to the `userinit.exe` process, after which all child processes started by a user will inherit a copy of the access token from their creator and will run under the privileges of the same access token.

### Categories of access tokens

- Windows access tokens are categorized based on the varying security levels assigned to them. These security levels are used to determine the privileges that are assigned to a specific token.

- An access token will typically be assigned one of the following security levels:
	+ <U>Impersonate-level</U> tokens are created as a direct result of a non-interactive login Windows, typically through specific system services or domain logons.
	+ <u>Delegate-level</u> tokens are typically created through an interactive login on Windows, primarily through a traditional login or through remote access protocols such as RDP.

### Privileges required for token impersonation

- The process of impersonating access tokens to elevate privileges on a system will primarily depend on the privileges assigned to the account that has been exploited to gain initial access as well as the impersonation or delegation tokens available.

- The following are the privileges that are required for a successful impersonation attack:
	+ SeAssignPrimaryToken: This allows a user to impersonate tokens.
	+ SeCreateToken: This allows a user to create an arbitrary token with administrative privileges.
	+ SelmpersonatePrivilege: This allows a user to create a process under the security context of another user typically with administrative privileges.

### The incognito module in `MSF`

- Incognito is a built-in `meterpreter` module that was originally a standalone application that allows you to impersonate user tokens after successful exploitation.

- We can use the incognito module to display a list of available tokens that we can impersonate.

### Exploitation steps

*We are assuming that we already have initial access to the target computer/web server.*

1) Run `sysinfo` to get further details of the target.
2) The `meterpreter` session might be running as `x86` but since we don't have the appropriate privileges, we cannot migrate. 
3) Run command `getprivs` to check the privileges of the current user.
4) If we have the `SeImpersonatePrivilege`, it means we can use the current user account to impersonate other access tokens available.
5) Load the incognito module - `load incognito`
6) Now we can list the tokens of the user accounts - `list tokens -u`
7) It'll show the impersonation and delegation token names.
8) We can now use the command - `impersonate_token <token-name>` 
9) This will impersonate the privileged user account.
10) We can now successfully migrate to a `x64` bit process and check our privileges.
